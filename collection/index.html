<!DOCTYPE html>
<html>

<head>
  <title>소장품</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDG5dM9sdYj1Gzk9otxoBwlE2c2YZjcGkY",
      authDomain: "collection-6de28.firebaseapp.com",
      databaseURL: "https://collection-6de28-default-rtdb.firebaseio.com",
      projectId: "collection-6de28",
      storageBucket: "collection-6de28.firebasestorage.app",
      messagingSenderId: "532985173114",
      appId: "1:532985173114:web:9c97c5f7cb796ad62bd7c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    const db = getDatabase(app);
    
    // DOM 로드 후 버튼 이벤트 연결
    document.addEventListener("DOMContentLoaded", () => {
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.addEventListener("click", () => {
        signInWithPopup(auth, provider)
  .then((result) => {
    // This gives you a Google Access Token. You can use it to access the Google API.
    const credential = GoogleAuthProvider.credentialFromResult(result);
    const token = credential.accessToken;
    // The signed-in user info.
    const user = result.user;
    console.log(user);
    saveUserProfile(user);
    // IdP data available using getAdditionalUserInfo(result)
    // ...
  }).catch((error) => {
    // Handle Errors here.
    const errorCode = error.code;
    const errorMessage = error.message;
    // The email of the user's account used.
    const email = error.customData.email;
    // The AuthCredential type that was used.
    const credential = GoogleAuthProvider.credentialFromError(error);
    // ...
  });
      });});

    // 사용자 프로필 저장 함수
    async function saveUserProfile(user) {
      const userRef = ref(db, "users/" + user.uid + "/profile");
      const snapshot = await get(userRef);

      if (!snapshot.exists()) {
        await set(userRef, {
          email: user.email,
          name: user.displayName,
          photo: user.photoURL,
          createdAt: Date.now()
        });
        console.log("프로필 저장 완료");
      } else {
        console.log("기존 프로필 존재");
      }
    }
  </script>

  <script src="/collection/script.js" defer></script>
  <link rel="stylesheet" href="/collection/styles.css" />
  <script src="./script.js" defer></script>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="header">
    <div class="header-left">
      <label>Collection</label>
    </div>
    <div class="header-right">
      <button id="loginBtn">로그인</button>
      <label id="amount"></label>
      <div>
        <input id="sizeRange" type="range" min="1" max="10" value="10">
      </div>
      <div>
        <input type="checkbox" id="isCollectedCheckbox" name="isCollectedCheckbox" checked />
        <label for="isCollectedCheckbox">수집 여부</label>
      </div>
      <div>
        <input type="checkbox" id="isHadCheckbox" name="isHadCheckbox" />
        <label for="isHadCheckbox">보유만</label>
      </div>
      <div>
        <input type="checkbox" id="statusCheckbox" name="statusCheckbox" />
        <label for="statusCheckbox">미개봉만</label>
      </div>
      <input id="searchBox" type="text">
      <label for="nation">국가</label>
      <select class="nationSelect" id="nation" name="nation">
        <option value="All" selected>All</option>
        <option value="KR">KR</option>
        <option value="JP">JP</option>
      </select>
      <label for="remarks">분류</label>
      <select class="remarksSelect" id="remarks" name="remarks">
        <option value="All">All</option>
      </select>
      <select id="selectSort" name="sort">
        <option value="releaseDateAsc">발매일 ↑</option>
        <option value="releaseDateDesc">발매일 ↓</option>
        <option value="nameAsc">이름 ↑</option>
        <option value="nameDesc">이름 ↓</option>
      </select>
      <label id="count" style="width: 80px;"></label>
    </div>
  </div>

  <div class="main-container">
    <div class="category">
      <select id="for" multiple name="items" size="35">
        <!-- 기존 옵션 그대로 -->
      </select>
    </div>
    <div id="results" class="card-container"></div>
  </div>
</body>

</html>
